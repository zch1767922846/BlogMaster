{% extends 'admin/base.html' %}

{% block main %}
<div class="layui-fluid">
    <div class="layui-row">
        <table class="layui-hide" id="posts-table" lay-filter="filter-post-table"></table>
    </div>
</div>
{% endblock %}

{% block script %}
{{ super() }}
<script type="text/html" id="toolbar-posts">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="add">添加文章</button>
    </div>
</script>

<script type="text/html" id="statusColumn">
{% raw %}
    {{# if(d.status){ }}
        <span class="layui-badge layui-bg-green">已发布</span>
    {{# } else { }}
        <span class="layui-badge layui-bg-orange">草稿</span>
    {{# } }}
{% endraw %}
</script>

<script type="text/html" id="tagsColumn">
{% raw %}
    {{# if(d.tag_names && d.tag_names.length > 0){ }}
        {{# layui.each(d.tag_names, function(index, tag){ }}
            {{# if(tag){ }}
                <span class="layui-badge layui-bg-blue">{{ tag }}</span>
            {{# } }}
        {{# }); }}
    {{# } else { }}
        <span class="layui-badge layui-bg-gray">无标签</span>
    {{# } }}
{% endraw %}
</script>

<script type="text/html" id="toolbar-post">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>

<script>
layui.use(['table', 'layer'], function() {
    var table = layui.table;
    var layer = layui.layer;

    // 渲染表格（简化配置，增强容错）
    table.render({
        elem: '#posts-table',
        url: '/admin/posts',
        method: 'GET',
        toolbar: '#toolbar-posts',
        request: {
            pageName: 'page',
            limitName: 'limit'
        },
        response: {
            statusName: 'code',
            statusCode: 20000000,  // 与后端成功码严格一致
            msgName: 'message',
            countName: 'count',
            dataName: 'data'
        },
        cols: [[
            {field: 'id', title: 'ID', width: 80, fixed: 'left', sort: true},
            {field: 'title', title: '文章标题', width: 200},
            {field: 'author_name', title: '作者', width: 100},
            {field: 'category_name', title: '分类', width: 100},
            {field: 'tag_names', title: '标签', width: 200, templet: '#tagsColumn'},  // 改为tag_names字段
            {field: 'counter', title: '阅读量', width: 80},
            {field: 'status', title: '状态', width: 100, templet: '#statusColumn'},
            {field: 'publishtime', title: '发布时间', width: 180},
            {fixed: 'right', title: '操作', toolbar: '#toolbar-post', width: 150}
        ]],
        page: true,
        limit: 10,
        limits: [10, 20, 30],
        height: 'full-120',
        done: function(res, curr, count) {
            // 详细的错误日志
            console.log('表格数据加载结果:', res);
            if (res.code !== 20000000) {
                layer.msg('数据加载失败: ' + (res.message || '未知错误'), {icon: 5, time: 3000});
                // 打印完整错误信息到控制台
                console.error('数据加载失败详情:', res);
            } else if (res.data.length === 0) {
                layer.msg('暂无文章数据', {icon: 6, time: 2000});
            }
        },
        error: function(xhr, status, error) {
            layer.msg('请求异常: ' + error, {icon: 5, time: 3000});
            console.error('AJAX请求错误:', xhr, status, error);
        }
    });

    // 工具栏事件
    table.on('toolbar(filter-post-table)', function(obj) {
        if (obj.event === 'add') {
            layer.open({
                type: 2,
                title: '添加文章',
                area: ['90%', '90%'],
                content: '/admin/post',
                maxmin: true
            });
        }
    });

    // 行操作事件
    table.on('tool(filter-post-table)', function(obj) {
        var data = obj.data;
        if (obj.event === 'edit') {
            layer.open({
                type: 2,
                title: '编辑文章',
                area: ['90%', '90%'],
                content: '/admin/post/' + data.id,
                maxmin: true
            });
        } else if (obj.event === 'del') {
            layer.confirm('确定删除该文章吗？', {icon: 3, title: '提示'}, function(index) {
                $.ajax({
                    url: '/admin/post/' + data.id,
                    type: 'DELETE',
                    dataType: 'json',
                    success: function(res) {
                        if (res.code === 20000000) {
                            layer.msg('删除成功', {icon: 1, time: 2000});
                            obj.del();
                        } else {
                            layer.msg('删除失败: ' + res.message, {icon: 5, time: 3000});
                        }
                    },
                    error: function(xhr, status, error) {
                        layer.msg('删除请求失败: ' + error, {icon: 5, time: 3000});
                    }
                });
                layer.close(index);
            });
        }
    });
});
</script>
{% endblock %}