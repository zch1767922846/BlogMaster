{% extends 'blog/base_with_nav.html' %}

{% block title %}{{ post.title }} - æˆ‘çš„åšå®¢{% endblock %}

{% block content %}
<article class="card">
    <div class="card-body">
        <header class="article-header">
            <h1 class="article-title">{{ post.title }}</h1>
            <div class="article-meta d-flex flex-wrap gap-3 text-muted small">
                <span class="d-flex align-items-center">
                    <i class="fa fa-calendar me-1"></i>
                    å‘å¸ƒäº {{ post.publishtime.strftime('%Y-%m-%d %H:%M') if post.publishtime else '' }}
                </span>
                <span class="d-flex align-items-center">
                    <i class="fa fa-folder me-1"></i>
                    {{ category.name if category else 'æœªåˆ†ç±»' }}
                </span>
                <span class="d-flex align-items-center">
                    <i class="fa fa-user me-1"></i>
                    {{ author.nickname if author and author.nickname else (author.username if author else 'æœªçŸ¥ä½œè€…') }}
                </span>
                <span class="d-flex align-items-center">
                    <i class="fa fa-eye me-1"></i>
                    é˜…è¯»æ¬¡æ•°: {{ post.counter or 0 }}
                </span>
                <span class="d-flex align-items-center">
                    <i class="fa fa-heart me-1"></i>
                    æ”¶è—æ¬¡æ•°: {{ post.favorites_count or 0 }}
                </span>
            </div>
        </header>

        <section class="article-content mb-5">
            {{ post.content|safe }}
            
            <!-- æ˜¾ç¤ºæ–‡ç« å…³è”çš„å¤šåª’ä½“æ–‡ä»¶ -->
            {% if post.medias %}
            <div class="article-medias mt-4">
                <h5 class="mb-3">ç›¸å…³é™„ä»¶</h5>
                <div class="row g-3">
                    {% for media in post.medias %}
                    <div class="col-md-3 col-sm-6 col-6">
                        {% if media.is_image %}
                            <a href="{{ url_for('bp_admin.uploaded_files', filename=media.filepath) }}" target="_blank" class="d-block text-center">
                                <img src="{{ url_for('bp_admin.uploaded_files', filename=media.filepath) }}" class="img-fluid rounded border" alt="{{ media.filename }}" style="max-height: 150px; object-fit: cover;">
                            </a>
                        {% elif media.is_video %}
                            <video controls class="img-fluid rounded border" style="max-height: 150px;">
                                <source src="{{ url_for('bp_admin.uploaded_files', filename=media.filepath) }}" type="{{ media.mime_type }}">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                            </video>
                        {% elif media.is_audio %}
                            <audio controls class="w-100">
                                <source src="{{ url_for('bp_admin.uploaded_files', filename=media.filepath) }}" type="{{ media.mime_type }}">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                            </audio>
                        {% else %}
                            <div class="media-file text-center p-3 border rounded bg-light">
                                <i class="fa {% if media.is_document %}fa-file-text{% elif media.is_archive %}fa-file-archive{% else %}fa-file{% endif %} fa-2x text-muted mb-2"></i>
                                <div class="media-filename small text-truncate" title="{{ media.filename }}">{{ media.filename|truncate(20, True) }}</div>
                                <div class="media-size small text-muted">{{ (media.file_size/1024)|round(2) }} KB</div>
                                <a href="{{ url_for('bp_admin.uploaded_files', filename=media.filepath) }}" class="btn btn-sm btn-outline-primary mt-2 d-block" target="_blank">ä¸‹è½½</a>
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </section>

        {% if tags %}
        <div class="tag-cloud mb-4">
            <h6 class="mb-3">æ ‡ç­¾:</h6>
            {% for tag in tags %}
                <a href="{{ url_for('bp_blog.tag_posts', tag_id=tag.id) }}" class="btn btn-outline-secondary btn-sm me-2 mb-2">{{ tag.name }}</a>
            {% endfor %}
        </div>
        {% endif %}
        
        {% if current_user.is_authenticated %}
        <div class="mb-4">
            {% if current_user.has_favorited(post) %}
            <form method="post" action="{{ url_for('bp_blog.unfavorite_post', post_id=post.id) }}" class="d-inline">
                <button type="submit" class="btn btn-danger">
                    <i class="fa fa-heart"></i> å–æ¶ˆæ”¶è—
                </button>
            </form>
            {% else %}
            <form method="post" action="{{ url_for('bp_blog.favorite_post', post_id=post.id) }}" class="d-inline">
                <button type="submit" class="btn btn-outline-danger">
                    <i class="fa fa-heart"></i> æ”¶è—æ–‡ç« 
                </button>
            </form>
            {% endif %}
        </div>
        {% endif %}
    </div>
</article>

<!-- è¯„è®ºåŒºåŸŸ -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">è¯„è®º ({{ comments|length }})</h5>
    </div>
    <div class="card-body">
        <!-- è¯„è®ºåˆ—è¡¨ -->
        {% if comments %}
            {% for comment in comments %}
            <div class="border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between">
                    <strong>{{ comment.author }}</strong>
                    <small class="text-muted">{{ comment.date.strftime('%Y-%m-%d %H:%M') }}</small>
                </div>
                <p class="mt-2 mb-0">{{ comment.content }}</p>
                
                <!-- æ˜¾ç¤ºè¯„è®ºå…³è”çš„å¤šåª’ä½“æ–‡ä»¶ -->
                {% if comment.medias %}
                <div class="comment-medias mt-2">
                    {% for media in comment.medias %}
                    <div class="comment-media-item d-inline-block me-2">
                        {% if media.is_image %}
                            <a href="{{ url_for('bp_admin.uploaded_files', filename=media.filepath) }}" target="_blank">
                                <img src="{{ url_for('bp_admin.uploaded_files', filename=media.filepath) }}" class="img-thumbnail" style="max-height: 100px; max-width: 100px; object-fit: cover;" alt="{{ media.filename }}">
                            </a>
                        {% elif media.is_video %}
                            <video controls class="img-thumbnail" style="max-height: 100px;">
                                <source src="{{ url_for('bp_admin.uploaded_files', filename=media.filepath) }}" type="{{ media.mime_type }}">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                            </video>
                        {% elif media.is_audio %}
                            <audio controls style="width: 200px;">
                                <source src="{{ url_for('bp_admin.uploaded_files', filename=media.filepath) }}" type="{{ media.mime_type }}">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                            </audio>
                        {% else %}
                            <div class="comment-media-file d-inline-block">
                                <i class="fa {% if media.is_document %}fa-file-text{% elif media.is_archive %}fa-file-archive{% else %}fa-file{% endif %} text-muted"></i>
                                <a href="{{ url_for('bp_admin.uploaded_files', filename=media.filepath) }}" target="_blank" class="ms-1 text-truncate" style="max-width: 100px;" title="{{ media.filename }}">{{ media.filename|truncate(15, True) }}</a>
                                <small class="text-muted">({{ (media.file_size/1024)|round(2) }} KB)</small>
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</p>
        {% endif %}

        <!-- è¯„è®ºè¡¨å• -->
        <hr>
        {% if current_user.is_authenticated %}
        <h5>å‘è¡¨è¯„è®º</h5>
        <form method="post" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
            <div class="mb-3 position-relative">
                <label for="content" class="form-label">è¯„è®ºå†…å®¹ *</label>
                {{ form.content(class="form-control", id="content", rows="4") }}
                {% for error in form.content.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
                
                <!-- ä¸Šä¼ å¤šåª’ä½“æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰ -->
                <div class="mb-3 mt-3">
                    <label for="media_files" class="form-label">ä¸Šä¼ å¤šåª’ä½“æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</label>
                    {{ form.media_files(class="form-control", id="media_files") }}
                    {% for error in form.media_files.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                
                <!-- è¡¨æƒ…åŒ…é€‰æ‹©å™¨å’Œå‘è¡¨è¯„è®ºæŒ‰é’®å¸ƒå±€ -->
                <div class="mt-2 d-flex justify-content-between align-items-start">
                    <!-- è¡¨æƒ…åŒ…é€‰æ‹©å™¨ -->
                    <div class="d-flex align-items-start position-relative" style="min-height: 200px;">
                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="emoji-toggle-btn" style="z-index: 1001;">
                            <i class="fa fa-smile"></i> è¡¨æƒ…
                        </button>
                    <!-- è¡¨æƒ…åŒ…é€‰æ‹©å™¨å¼¹å‡ºæ¡† -->
                    <div id="emoji-selector-popup" class="emoji-selector-popup position-absolute" style="display: none; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; width: 300px;">
                        <div class="emoji-grid row g-1">
                            {% for emoji_code, emoji_char in [
                                ('ğŸ˜€', 'ğŸ˜€'), ('ğŸ˜ƒ', 'ğŸ˜ƒ'), ('ğŸ˜„', 'ğŸ˜„'), ('ğŸ˜', 'ğŸ˜'), 
                                ('ğŸ˜†', 'ğŸ˜†'), ('ğŸ˜…', 'ğŸ˜…'), ('ğŸ˜‚', 'ğŸ˜‚'), ('ğŸ¤£', 'ğŸ¤£'),
                                ('ğŸ˜Š', 'ğŸ˜Š'), ('ğŸ˜‡', 'ğŸ˜‡'), ('ğŸ™‚', 'ğŸ™‚'), ('ğŸ™ƒ', 'ğŸ™ƒ'),
                                ('ğŸ˜‰', 'ğŸ˜‰'), ('ğŸ˜Œ', 'ğŸ˜Œ'), ('ğŸ˜', 'ğŸ˜'), ('ğŸ¥°', 'ğŸ¥°'),
                                ('ğŸ˜˜', 'ğŸ˜˜'), ('ğŸ˜—', 'ğŸ˜—'), ('ğŸ˜™', 'ğŸ˜™'), ('ğŸ˜š', 'ğŸ˜š'),
                                ('ğŸ˜‹', 'ğŸ˜‹'), ('ğŸ˜›', 'ğŸ˜›'), ('ğŸ˜', 'ğŸ˜'), ('ğŸ˜œ', 'ğŸ˜œ'),
                                ('ğŸ¤ª', 'ğŸ¤ª'), ('ğŸ¤¨', 'ğŸ¤¨'), ('ğŸ§', 'ğŸ§'), ('ğŸ¤“', 'ğŸ¤“'),
                                ('ğŸ˜', 'ğŸ˜'), ('ğŸ¤©', 'ğŸ¤©'), ('ğŸ¥³', 'ğŸ¥³'), ('ğŸ˜', 'ğŸ˜'),
                                ('ğŸ˜’', 'ğŸ˜’'), ('ğŸ˜', 'ğŸ˜'), ('ğŸ˜”', 'ğŸ˜”'), ('ğŸ˜Ÿ', 'ğŸ˜Ÿ'),
                                ('ğŸ˜•', 'ğŸ˜•'), ('ğŸ™', 'ğŸ™'), ('â˜¹ï¸', 'â˜¹ï¸'), ('ğŸ˜£', 'ğŸ˜£'),
                                ('ğŸ˜–', 'ğŸ˜–'), ('ğŸ˜«', 'ğŸ˜«'), ('ğŸ˜©', 'ğŸ˜©'), ('ğŸ¥º', 'ğŸ¥º'),
                                ('ğŸ˜¢', 'ğŸ˜¢'), ('ğŸ˜­', 'ğŸ˜­'), ('ğŸ˜¤', 'ğŸ˜¤'), ('ğŸ˜ ', 'ğŸ˜ '),
                                ('ğŸ˜¡', 'ğŸ˜¡'), ('ğŸ¤¬', 'ğŸ¤¬'), ('ğŸ¤¯', 'ğŸ¤¯'), ('ğŸ˜³', 'ğŸ˜³'),
                                ('ğŸ¥µ', 'ğŸ¥µ'), ('ğŸ¥¶', 'ğŸ¥¶'), ('ğŸ˜±', 'ğŸ˜±'), ('ğŸ˜¨', 'ğŸ˜¨'),
                                ('ğŸ˜°', 'ğŸ˜°'), ('ğŸ˜¥', 'ğŸ˜¥'), ('ğŸ˜“', 'ğŸ˜“'), ('ğŸ¤—', 'ğŸ¤—'),
                                ('ğŸ¤”', 'ğŸ¤”'), ('ğŸ¤­', 'ğŸ¤­'), ('ğŸ¤«', 'ğŸ¤«'), ('ğŸ¤¥', 'ğŸ¤¥'),
                                ('ğŸ˜¶', 'ğŸ˜¶'), ('ğŸ˜', 'ğŸ˜'), ('ğŸ˜‘', 'ğŸ˜‘'), ('ğŸ˜¬', 'ğŸ˜¬'),
                                ('ğŸ™„', 'ğŸ™„'), ('ğŸ˜¯', 'ğŸ˜¯'), ('ğŸ˜¦', 'ğŸ˜¦'), ('ğŸ˜§', 'ğŸ˜§'),
                                ('ğŸ˜®', 'ğŸ˜®'), ('ğŸ˜²', 'ğŸ˜²'), ('ğŸ¥±', 'ğŸ¥±'), ('ğŸ˜´', 'ğŸ˜´'),
                                ('ğŸ¤¤', 'ğŸ¤¤'), ('ğŸ˜ª', 'ğŸ˜ª'), ('ğŸ˜µ', 'ğŸ˜µ'), ('ğŸ¤', 'ğŸ¤'),
                                ('ğŸ¥´', 'ğŸ¥´'), ('ğŸ¤¢', 'ğŸ¤¢'), ('ğŸ¤®', 'ğŸ¤®'), ('ğŸ¤§', 'ğŸ¤§'),
                                ('ğŸ˜·', 'ğŸ˜·'), ('ğŸ¤’', 'ğŸ¤’'), ('ğŸ¤•', 'ğŸ¤•'), ('ğŸ¤‘', 'ğŸ¤‘'),
                                ('ğŸ¤ ', 'ğŸ¤ '), ('ğŸ˜ˆ', 'ğŸ˜ˆ'), ('ğŸ‘¿', 'ğŸ‘¿'), ('ğŸ‘¹', 'ğŸ‘¹'),
                                ('ğŸ‘º', 'ğŸ‘º'), ('ğŸ¤¡', 'ğŸ¤¡'), ('ğŸ’©', 'ğŸ’©'), ('ğŸ‘»', 'ğŸ‘»'),
                                ('ğŸ’€', 'ğŸ’€'), ('â˜ ï¸', 'â˜ ï¸'), ('ğŸ‘½', 'ğŸ‘½'), ('ğŸ‘¾', 'ğŸ‘¾'),
                                ('ğŸ¤–', 'ğŸ¤–'), ('ğŸƒ', 'ğŸƒ'), ('ğŸ˜º', 'ğŸ˜º'), ('ğŸ˜¸', 'ğŸ˜¸'),
                                ('ğŸ˜¹', 'ğŸ˜¹'), ('ğŸ˜»', 'ğŸ˜»'), ('ğŸ˜¼', 'ğŸ˜¼'), ('ğŸ˜½', 'ğŸ˜½'),
                                ('ğŸ™€', 'ğŸ™€'), ('ğŸ˜¿', 'ğŸ˜¿'), ('ğŸ˜¾', 'ğŸ˜¾'), ('ğŸ‘¶', 'ğŸ‘¶'),
                                ('ğŸ‘¦', 'ğŸ‘¦'), ('ğŸ‘§', 'ğŸ‘§'), ('ğŸ‘¨', 'ğŸ‘¨'), ('ğŸ‘©', 'ğŸ‘©'),
                                ('ğŸ‘´', 'ğŸ‘´'), ('ğŸ‘µ', 'ğŸ‘µ'), ('ğŸ‘®', 'ğŸ‘®'), ('ğŸ•µï¸', 'ğŸ•µï¸'),
                                ('ğŸ¤š', 'ğŸ¤š'), ('ğŸ–', 'ğŸ–'), ('âœ‹', 'âœ‹'), ('ğŸ––', 'ğŸ––'), 
                                ('ğŸ‘Œ', 'ğŸ‘Œ'), ('ğŸ¤', 'ğŸ¤'), ('âœŒï¸', 'âœŒï¸'), ('ğŸ¤', 'ğŸ¤'),
                                 ('ğŸ¤Ÿ', 'ğŸ¤Ÿ'), ('ğŸ¤˜', 'ğŸ¤˜'), ('ğŸ¤™', 'ğŸ¤™'), ('ğŸ‘ˆ', 'ğŸ‘ˆ'), 
                                 ('ğŸ‘‰', 'ğŸ‘‰'), ('ğŸ‘†', 'ğŸ‘†'), ('ğŸ–•', 'ğŸ–•'), ('ğŸ‘‡', 'ğŸ‘‡'), 
                                 ('â˜ï¸', 'â˜ï¸'), ('ğŸ‘', 'ğŸ‘'), ('ğŸ‘', 'ğŸ‘'), ('âœŠ', 'âœŠ'), 
                                 ('ğŸ¤›', 'ğŸ¤›'), ('ğŸ¤œ', 'ğŸ¤œ'), ('ğŸ‘', 'ğŸ‘'), ('ğŸ™Œ', 'ğŸ™Œ'),
                                ('ğŸ‘', 'ğŸ‘'), ('ğŸ¤²', 'ğŸ¤²'), ('ğŸ¤', 'ğŸ¤'), ('ğŸ™', 'ğŸ™'), 
                                ('âœï¸', 'âœï¸'), ('ğŸ’…', 'ğŸ’…'), ('ğŸ¤³', 'ğŸ¤³'), ('ğŸ’ª', 'ğŸ’ª'), 
                                ('ğŸ¦¾', 'ğŸ¦¾'), ('ğŸ¦¿', 'ğŸ¦¿'), ('ğŸ¦µ', 'ğŸ¦µ'), ('ğŸ¦¶', 'ğŸ¦¶'), 
                                ('ğŸ‘‚', 'ğŸ‘‚'), ('ğŸ¦»', 'ğŸ¦»'), ('ğŸ‘ƒ', 'ğŸ‘ƒ'), ('ğŸ§ ', 'ğŸ§ '), 
                                ('ğŸ¦´', 'ğŸ¦´'), ('ğŸ‘€', 'ğŸ‘€'), ('ğŸ‘', 'ğŸ‘'), ('ğŸ‘„', 'ğŸ‘„')
                            ] %}
                            <div class="col-1 p-1">
                                <span class="emoji-option d-flex justify-content-center align-items-center border rounded bg-light" 
                                      data-emoji="{{ emoji_char }}" 
                                      style="cursor: pointer; font-size: 1.2em; height: 30px;">{{ emoji_char }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    </div>
                    
                    <!-- å‘è¡¨è¯„è®ºæŒ‰é’® -->
                    <div class="d-flex align-items-start">
                        {{ form.submit(class="btn btn-primary", value="å‘è¡¨è¯„è®º") }}
                    </div>
                </div>    
            </div>
        </form>
        
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è¡¨æƒ…åŒ…é€‰æ‹©å™¨åŠŸèƒ½
            const emojiToggleBtn = document.getElementById('emoji-toggle-btn');
            const emojiSelectorPopup = document.getElementById('emoji-selector-popup');
            const contentTextarea = document.getElementById('content');
            
            // åˆ‡æ¢è¡¨æƒ…åŒ…é€‰æ‹©å™¨æ˜¾ç¤º/éšè—
            emojiToggleBtn.addEventListener('click', function(e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                const isVisible = emojiSelectorPopup.style.display !== 'none';
                
                if (isVisible) {
                    emojiSelectorPopup.style.display = 'none';
                } else {
                    // è®¡ç®—å¼¹å‡ºæ¡†ä½ç½®ï¼Œä½¿å…¶å‡ºç°åœ¨æŒ‰é’®å³è¾¹
                    const btnRect = emojiToggleBtn.getBoundingClientRect();
                    const containerRect = emojiToggleBtn.parentElement.getBoundingClientRect();
                    
                    emojiSelectorPopup.style.display = 'block';
                    // ä¿®æ­£å¼¹å‡ºæ¡†ä½ç½®ï¼šæ˜¾ç¤ºåœ¨æŒ‰é’®å³è¾¹
                    emojiSelectorPopup.style.top = (btnRect.top - containerRect.top) + 'px';
                    emojiSelectorPopup.style.left = (btnRect.right - containerRect.left + 5) + 'px';
                }
            });
            
            // ç‚¹å‡»è¡¨æƒ…ç¬¦å·æ·»åŠ åˆ°æ–‡æœ¬æ¡†
            const emojiOptions = document.querySelectorAll('.emoji-option');
            emojiOptions.forEach(emoji => {
                emoji.addEventListener('click', function() {
                    const selectedEmoji = this.getAttribute('data-emoji');
                    contentTextarea.value += selectedEmoji;
                    contentTextarea.focus();
                    
                    // æ·»åŠ åéšè—å¼¹å‡ºæ¡†
                    emojiSelectorPopup.style.display = 'none';
                });
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—è¡¨æƒ…åŒ…é€‰æ‹©å™¨
            document.addEventListener('click', function(e) {
                if (!emojiSelectorPopup.contains(e.target) && e.target !== emojiToggleBtn) {
                    emojiSelectorPopup.style.display = 'none';
                }
            });
        });
        </script>
        {% else %}
        <p class="text-muted">
            è¯· <a href="{{ url_for('bp_blog.login') }}">ç™»å½•</a> åå‘è¡¨è¯„è®º
        </p>
        {% endif %}
    </div>
</div>

<div class="author-card card mt-4">
    <div class="card-body">
        <h5 class="card-title">å…³äºä½œè€…</h5>
        <p class="card-text">{{ author.nickname if author and author.nickname else (author.username if author else 'æœªçŸ¥ä½œè€…') }}</p>
    </div>
</div>
{% endblock %}